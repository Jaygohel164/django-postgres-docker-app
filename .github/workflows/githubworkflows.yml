name: CI and Deploy to EC2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: hello
          POSTGRES_USER: hello
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U hello"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      POSTGRES_HOST: localhost
      POSTGRES_DB: hello
      POSTGRES_USER: hello
      POSTGRES_PASSWORD: password
      POSTGRES_PORT: 5432
      SECRET_KEY: ci-secret-key
      DEBUG: "false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client libpq-dev

      - name: Install uv package manager
        run: |
          python -m pip install --upgrade pip
          pip install uv

      - name: Install project dependencies
        run: uv sync --frozen --no-dev

      - name: Wait for PostgreSQL to be ready
        run: |
          for i in {1..30}; do
            pg_isready -h localhost -p 5432 -U hello && break || sleep 1
          done
        env:
          PGPASSWORD: password

      - name: Run Django migrations
        run: uv run python src/manage.py migrate --noinput

      - name: Run Django tests
        run: uv run python src/manage.py test --verbosity=2

      - name: Collect static files
        run: uv run python src/manage.py collectstatic --noinput

  deploy:
    name: Deploy to EC2
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.6.1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            set -e
            echo "Deploying to EC2..."
            cd ${{ secrets.REMOTE_APP_DIR }}
            
            # Fetch latest code
            git fetch --all
            git reset --hard ${{ github.sha }}
            
            # Pull latest Docker images and rebuild
            docker compose pull || true
            docker compose up -d --build
            
            # Run migrations inside web container
            docker compose exec -T web uv run python src/manage.py migrate --noinput || true
            
            # Collect static files
            docker compose exec -T web uv run python src/manage.py collectstatic --noinput || true
            
            echo "Deployment complete!"

# ============================================================
# REQUIRED GITHUB SECRETS (Settings → Secrets → Actions):
# ============================================================
# EC2_HOST              - IP address or hostname of your EC2
# EC2_USER              - SSH username (e.g., ubuntu, ec2-user)
# EC2_SSH_KEY           - Private SSH key (PEM file contents)
# EC2_SSH_PORT          - SSH port (optional, defaults to 22)
# REMOTE_APP_DIR        - Full path to app on EC2 (e.g., /home/ubuntu/app)
#
# OPTIONAL - For Docker image registry (if pushing images):
# DOCKER_USERNAME       - Docker Hub or registry username
# DOCKER_PASSWORD       - Docker Hub or registry password/token
# DOCKER_REGISTRY       - Registry URL (e.g., ghcr.io, docker.io)
# ============================================================
